name: 完 ocuklar Duymas覺n Emine

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */2 * * *' #Eminenin 癟al覺ma saatleri

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Hatal覺 ve 襤ptal Edilen Workflow'lar覺 Temizle
        uses: actions/github-script@v7
        with:
          script: |
            async function deleteWorkflowRuns() {
              let page = 1;
              let hasMoreRuns = true;
              let totalFailedDeleted = 0;
              let totalCancelledDeleted = 0;
              let totalSuccessDeleted = 0;
              
              while (hasMoreRuns) {
                try {
                  // Hatal覺 workflow'lar覺 al
                  const failedRuns = await github.rest.actions.listWorkflowRunsForRepo({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    status: 'failure',
                    per_page: 100,
                    page: page
                  });
                  
                  // 襤ptal edilen workflow'lar覺 al
                  const cancelledRuns = await github.rest.actions.listWorkflowRunsForRepo({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    status: 'cancelled',
                    per_page: 100,
                    page: page
                  });
                  
                  const successRuns = await github.rest.actions.listWorkflowRunsForRepo({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    status: 'success',
                    per_page: 100,
                    page: page
                  });

                  // T羹m workflow'lar覺 birletir
                  const allRuns = [...failedRuns.data.workflow_runs, ...cancelledRuns.data.workflow_runs, ...successRuns.data.workflow_runs];
                  
                  if (!allRuns.length) {
                    hasMoreRuns = false;
                    break;
                  }
                  
                  console.log(`襤leniyor: Sayfa ${page}, ${allRuns.length} adet workflow`);
                  
                  for (const run of allRuns) {
                    try {
                      await github.rest.actions.deleteWorkflowRun({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        run_id: run.id
                      });
                      
                      if (run.conclusion === 'failure') {
                        totalFailedDeleted++;
                        console.log(`Hatal覺 Workflow Silindi: ${run.name} (ID: ${run.id})`);
                      } else if (run.conclusion === 'cancelled') {
                        totalCancelledDeleted++;
                        console.log(`襤ptal Edilen Workflow Silindi: ${run.name} (ID: ${run.id})`);
                      } else {
                        totalSuccessDeleted++;
                        console.log(`Baar覺l覺 Workflow Silindi: ${run.name} (ID: ${run.id})`);
                      }
                    } catch (deleteError) {
                      console.log(`Hata: ${run.name} (ID: ${run.id}) silinirken hata olutu:`, deleteError);
                    }
                  }
                  
                  page++;
                } catch (error) {
                  console.log('API 癟ar覺s覺 s覺ras覺nda hata:', error);
                  hasMoreRuns = false;
                }
              }
              
              console.log(`Temizleme ilemi tamamland覺.\nToplam ${totalFailedDeleted} hatal覺 workflow silindi.\nToplam ${totalCancelledDeleted} iptal edilen workflow silindi.\nToplam ${totalSuccessDeleted} baar覺l覺 workflow silindi.`);            }
            
            await deleteWorkflowRuns();    
